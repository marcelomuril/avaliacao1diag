<!DOCTYPE html>
<html lang="pt-BR">
<head>
  <meta charset="UTF-8">
  <title>CCM Sebastião Paraná - Avaliação Diagnóstica 2025</title>
  <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/papaparse@5.4.1/papaparse.min.js"></script>
  <style>
    body {
      font-family: Arial, sans-serif;
      background-color: #f8f9fa;
      margin: 0;
      padding: 0;
      color: #333;
    }
    header {
      background-color: #2c3e50;
      color: white;
      padding: 20px;
      text-align: center;
    }
    h1 {
      margin: 0;
      font-size: 28px;
    }
    h2 {
      margin: 5px 0 0;
      font-size: 20px;
      font-weight: normal;
    }
    main {
      padding: 20px;
      max-width: 1200px;
      margin: auto;
    }
    select, button {
      padding: 10px;
      margin: 10px 0;
      font-size: 16px;
    }
    canvas {
      background: #fff;
      border: 1px solid #ccc;
      padding: 10px;
      margin-top: 20px;
    }
    .descritores {
      margin-top: 30px;
    }
    .descritor {
      padding: 10px;
      border-bottom: 1px solid #ddd;
    }
    .descritor:nth-child(odd) {
      background: #f1f1f1;
    }
    .descritor:nth-child(even) {
      background: #ffffff;
    }
  </style>
</head>
<body>
  <header>
    <h1>CCM Sebastião Paraná</h1>
    <h2>1ª Avaliação Diagnóstica - 2025</h2>
  </header>
  <main>
    <label>Selecione a turma:</label>
    <select id="turmaSelect">
      <option value="">-- escolha --</option>
      <option value="9ano">9º Ano</option>
      <option value="3serie">3ª Série</option>
    </select>

    <br>
    <label>Selecione o aluno:</label>
    <select id="alunoSelect" disabled>
      <option value="">-- escolha a turma antes --</option>
    </select>

    <canvas id="grafico" width="1000" height="500"></canvas>

    <div id="descritores" class="descritores"></div>
  </main>

  <script>
    const arquivos = {
      "9ano": { port: "port9.csv", mat: "mat9.csv" },
      "3serie": { port: "port3.csv", mat: "mat3.csv" }
    };

    const dadosCSV = { port: [], mat: [] };
    let turmaSelecionada = "";
    let chart = null;

    // descritores genéricos
    const descritoresPort = {
      "H 01": "Localizar informações explícitas em um texto.",
      "H 02": "Inferir o sentido de uma palavra ou expressão em contexto.",
      "H 03": "Reconhecer a finalidade de um texto.",
      "H 04": "Identificar tema de um texto.",
      "H 05": "Distinguir fato de opinião.",
      "H 06": "Estabelecer relações de causa e consequência.",
      "H 07": "Identificar efeitos de ironia ou humor.",
      "H 08": "Reconhecer recursos linguísticos em textos argumentativos.",
      "H 09": "Inferir informações implícitas.",
      "H 10": "Relacionar partes de um texto.",
      "H 11": "Identificar variedade linguística usada.",
      "H 12": "Reconhecer marcas de coesão.",
      "H 13": "Reconhecer elementos de narrativa.",
      "H 14": "Analisar o ponto de vista em um texto.",
      "H 15": "Comparar textos sobre o mesmo tema."
    };

    const descritoresMat = {
      "HM 01": "Resolver problemas envolvendo as quatro operações.",
      "HM 02": "Calcular com números racionais em diferentes representações.",
      "HM 03": "Resolver problemas de proporcionalidade.",
      "HM 04": "Trabalhar com porcentagem e juros simples.",
      "HM 05": "Resolver problemas de equações do 1º grau.",
      "HM 06": "Interpretar informações em tabelas e gráficos.",
      "HM 07": "Resolver problemas de geometria plana.",
      "HM 08": "Resolver problemas de geometria espacial.",
      "HM 09": "Calcular perímetro e área de figuras planas.",
      "HM 10": "Calcular volume de sólidos geométricos.",
      "HM 11": "Resolver problemas com expressões algébricas.",
      "HM 12": "Analisar gráficos de funções.",
      "HM 13": "Resolver problemas de função do 1º grau.",
      "HM 14": "Resolver problemas de função quadrática.",
      "HM 15": "Analisar progressões aritméticas e geométricas.",
      "HM 16": "Resolver problemas de probabilidade.",
      "HM 17": "Resolver problemas de estatística descritiva.",
      "HM 18": "Resolver problemas de combinatória.",
      "HM 19": "Interpretar situações envolvendo grandezas físicas.",
      "HM 20": "Aplicar raciocínio lógico na resolução de problemas."
    };

    function carregarCSVs(turma, callback) {
      dadosCSV.port = [];
      dadosCSV.mat = [];

      Papa.parse(arquivos[turma].port, {
        download: true,
        header: true,
        skipEmptyLines: true,
        delimiter: ";", // CORREÇÃO AQUI ✅
        complete: res => {
          dadosCSV.port = res.data;
          if (dadosCSV.mat.length) callback();
        }
      });

      Papa.parse(arquivos[turma].mat, {
        download: true,
        header: true,
        skipEmptyLines: true,
        delimiter: ";", // CORREÇÃO AQUI ✅
        complete: res => {
          dadosCSV.mat = res.data;
          if (dadosCSV.port.length) callback();
        }
      });
    }

    document.getElementById("turmaSelect").addEventListener("change", function() {
      turmaSelecionada = this.value;
      const alunoSelect = document.getElementById("alunoSelect");
      alunoSelect.innerHTML = "<option value=''>-- carregando --</option>";
      alunoSelect.disabled = true;

      if (!turmaSelecionada) return;

      carregarCSVs(turmaSelecionada, () => {
        const alunos = [...new Set(dadosCSV.port.map(l => l["Estudante"]))];
        alunoSelect.innerHTML = "<option value=''>-- escolha --</option>";
        alunos.forEach(a => {
          alunoSelect.innerHTML += `<option value="${a}">${a}</option>`;
        });
        alunoSelect.disabled = false;
      });
    });

    document.getElementById("alunoSelect").addEventListener("change", function() {
      const aluno = this.value;
      if (!aluno) return;

      const dadosPort = dadosCSV.port.find(l => l["Estudante"] === aluno) || {};
      const dadosMat = dadosCSV.mat.find(l => l["Estudante"] === aluno) || {};

      const labels = [...Object.keys(descritoresPort), ...Object.keys(descritoresMat)];
      const portData = Object.keys(descritoresPort).map(h => parseInt(dadosPort[h] || 0));
      const matData = Object.keys(descritoresMat).map(h => parseInt(dadosMat[h] || 0));

      if (chart) chart.destroy();
      const ctx = document.getElementById("grafico").getContext("2d");

      chart = new Chart(ctx, {
        type: "bar",
        data: {
          labels: labels,
          datasets: [
            {
              label: "Português",
              data: [...portData, ...Array(matData.length).fill(null)],
              backgroundColor: "rgba(54,162,235,0.8)"
            },
            {
              label: "Matemática",
              data: [...Array(portData.length).fill(null), ...matData],
              backgroundColor: "rgba(255,99,132,0.8)"
            }
          ]
        },
        options: {
          responsive: true,
          maintainAspectRatio: false,
          plugins: {
            legend: {
              display: true,
              position: "top"
            },
            tooltip: {
              callbacks: {
                label: ctx => {
                  const key = ctx.label;
                  const desc = descritoresPort[key] || descritoresMat[key] || "";
                  return `${key}: ${ctx.formattedValue} acertos – ${desc}`;
                }
              }
            }
          },
          scales: {
            y: {
              beginAtZero: true,
              max: 20
            },
            x: {
              ticks: {
                autoSkip: false,
                maxRotation: 90,
                minRotation: 90
              }
            }
          }
        }
      });

      // Mostrar descritores abaixo do gráfico
      const descritoresDiv = document.getElementById("descritores");
      descritoresDiv.innerHTML = "<h3>Descritores das Habilidades</h3>";
      Object.entries(descritoresPort).forEach(([h, d]) => {
        descritoresDiv.innerHTML += `<div class="descritor"><b>${h}:</b> ${d}</div>`;
      });
      Object.entries(descritoresMat).forEach(([h, d]) => {
        descritoresDiv.innerHTML += `<div class="descritor"><b>${h}:</b> ${d}</div>`;
      });
    });
  </script>
</body>
</html>
