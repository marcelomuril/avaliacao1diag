<!DOCTYPE html>
<html lang="pt-BR">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>1ª Avaliação Diagnóstica 2025</title>
  <script src="https://cdn.tailwindcss.com"></script>
  <script src="https://cdn.jsdelivr.net/npm/papaparse@5.3.2/papaparse.min.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
</head>
<body class="bg-gray-50 text-gray-800">
  <header class="bg-blue-800 text-white p-6 text-center shadow-md">
    <h1 class="text-2xl font-bold">CCM SEBASTIÃO PARANÁ</h1>
    <h2 class="text-lg">1ª AVALIAÇÃO DIAGNÓSTICA 2025</h2>
  </header>

  <main class="max-w-5xl mx-auto p-6">
    <div class="mb-4">
      <label class="block mb-2 font-semibold">Selecione o Ano Escolar:</label>
      <select id="anoSelect" class="p-2 border rounded w-full">
        <option value="">-- Escolha --</option>
        <option value="9">9º Ano Fundamental</option>
        <option value="3">3ª Série Ensino Médio</option>
      </select>
    </div>

    <div class="mb-4">
      <label class="block mb-2 font-semibold">Selecione o Aluno:</label>
      <select id="alunoSelect" class="p-2 border rounded w-full">
        <option value="">-- Escolha --</option>
      </select>
    </div>

    <div class="bg-white shadow-lg rounded-lg p-4">
      <canvas id="grafico" class="w-full h-[400px]"></canvas>
    </div>
  </main>

  <script>
    // Arquivos CSV por ano
    const arquivos = {
      9: { port: "port9.csv", mat: "mat9.csv" },
      3: { port: "port3.csv", mat: "mat3.csv" }
    };

    // Descrições genéricas das habilidades
    const descritores = {
      H01: "Localizar informações explícitas em textos.",
      H02: "Inferir informações implícitas em textos.",
      H03: "Identificar a ideia principal de um texto.",
      H04: "Relacionar informações entre trechos de um texto.",
      H05: "Interpretar gráficos, tabelas e imagens.",
      H06: "Aplicar corretamente regras ortográficas.",
      H07: "Usar regras de gramática e pontuação.",
      H08: "Reconhecer e diferenciar gêneros textuais.",
      H09: "Efetuar cálculos básicos de operações.",
      H10: "Resolver problemas com mais de uma operação.",
      H11: "Compreender e manipular expressões algébricas.",
      H12: "Resolver equações e inequações simples.",
      H13: "Reconhecer e aplicar conceitos de geometria.",
      H14: "Interpretar e analisar dados estatísticos.",
      H15: "Resolver problemas envolvendo probabilidade."
    };

    let dadosPort = [], dadosMat = [];
    let grafico = null;

    const anoSelect = document.getElementById("anoSelect");
    const alunoSelect = document.getElementById("alunoSelect");
    const ctx = document.getElementById("grafico").getContext("2d");

    // Carrega os CSVs
    function carregarCSVs(ano) {
      return new Promise(resolve => {
        let { port, mat } = arquivos[ano];
        Papa.parse(port, {
          download: true,
          header: true,
          complete: results => {
            dadosPort = results.data;
            Papa.parse(mat, {
              download: true,
              header: true,
              complete: results2 => {
                dadosMat = results2.data;
                resolve();
              }
            });
          }
        });
      });
    }

    // Preenche lista de alunos
    function preencherAlunos() {
      alunoSelect.innerHTML = '<option value="">-- Escolha --</option>';
      dadosPort.forEach(linha => {
        if (linha["Estudante"]) {
          let opt = document.createElement("option");
          opt.value = linha["Estudante"];
          opt.textContent = linha["Estudante"];
          alunoSelect.appendChild(opt);
        }
      });
    }

    // Gera gráfico
    function gerarGrafico(aluno) {
      let linhaPort = dadosPort.find(l => l["Estudante"] === aluno);
      let linhaMat = dadosMat.find(l => l["Estudante"] === aluno);

      if (!linhaPort || !linhaMat) return;

      let labels = [];
      let valoresPort = [];
      let valoresMat = [];

      for (let i = 1; i <= 15; i++) {
        let col = "H " + String(i).padStart(2, "0");
        labels.push("H" + String(i).padStart(2, "0"));
        valoresPort.push(parseInt(linhaPort[col] || 0));
        valoresMat.push(parseInt(linhaMat[col] || 0));
      }

      if (grafico) grafico.destroy();

      grafico = new Chart(ctx, {
        type: "bar",
        data: {
          labels: labels,
          datasets: [
            {
              label: "Português",
              data: valoresPort,
              backgroundColor: "rgba(37, 99, 235, 0.7)"
            },
            {
              label: "Matemática",
              data: valoresMat,
              backgroundColor: "rgba(234, 88, 12, 0.7)"
            }
          ]
        },
        options: {
          responsive: true,
          maintainAspectRatio: false,
          plugins: {
            tooltip: {
              callbacks: {
                label: function(context) {
                  let habilidade = context.label;
                  let desc = descritores[habilidade] || "";
                  return context.dataset.label + ": " + context.raw + " → " + desc;
                }
              }
            }
          },
          scales: {
            y: {
              beginAtZero: true,
              title: { display: true, text: "Acertos" }
            }
          }
        }
      });
    }

    // Eventos
    anoSelect.addEventListener("change", async () => {
      if (anoSelect.value) {
        await carregarCSVs(anoSelect.value);
        preencherAlunos();
      }
    });

    alunoSelect.addEventListener("change", () => {
      if (alunoSelect.value) {
        gerarGrafico(alunoSelect.value);
      }
    });
  </script>
</body>
</html>
