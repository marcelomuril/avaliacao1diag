<!DOCTYPE html>
<html lang="pt-BR">
<head>
  <meta charset="UTF-8">
  <title>Avaliação Diagnóstica 2025</title>
  <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/papaparse@5.3.2/papaparse.min.js"></script>
  <style>
    body {
      font-family: "Segoe UI", Tahoma, Geneva, Verdana, sans-serif;
      margin: 0;
      padding: 0;
      background-color: #f9fafb;
      color: #333;
    }
    header {
      background: linear-gradient(90deg, #2b6cb0, #38a169);
      color: white;
      padding: 20px;
      text-align: center;
      box-shadow: 0 2px 6px rgba(0,0,0,0.2);
    }
    h1 {
      margin: 0;
      font-size: 1.8rem;
    }
    h2 {
      margin: 5px 0 0;
      font-weight: normal;
    }
    .container {
      max-width: 1000px;
      margin: auto;
      padding: 20px;
    }
    select {
      display: block;
      margin: 15px 0;
      padding: 10px;
      border-radius: 12px;
      border: 1px solid #ccc;
      background: #fff;
      font-size: 1rem;
      box-shadow: 0 2px 5px rgba(0,0,0,0.1);
      transition: border 0.3s, box-shadow 0.3s;
    }
    select:hover {
      border: 1px solid #2b6cb0;
      box-shadow: 0 2px 8px rgba(56, 161, 105, 0.3);
    }
    canvas {
      max-width: 100%;
      margin: 20px 0;
    }
    .descricoes {
      margin-top: 30px;
    }
    .habilidade {
      padding: 12px;
      border-radius: 8px;
      margin-bottom: 8px;
    }
    .habilidade:nth-child(odd) {
      background: #edf2f7;
    }
    .habilidade:nth-child(even) {
      background: #e6fffa;
    }
    .habilidade strong {
      display: block;
      color: #2b6cb0;
      margin-bottom: 5px;
    }
  </style>
</head>
<body>
  <header>
    <h1>CCM Sebastião Paraná</h1>
    <h2>1ª Avaliação Diagnóstica 2025</h2>
  </header>

  <div class="container">
    <label for="turmaSelect">Selecione a turma:</label>
    <select id="turmaSelect">
      <option value="">-- Escolha --</option>
      <option value="9ano">9º Ano Fundamental</option>
      <option value="3serie">3ª Série Ensino Médio</option>
    </select>

    <label for="alunoSelect">Selecione o aluno:</label>
    <select id="alunoSelect">
      <option value="">-- Escolha um aluno --</option>
    </select>

    <canvas id="grafico"></canvas>
    <div id="descricoes" class="descricoes"></div>
  </div>

  <script>
    const arquivos = {
      "9ano": ["port9.csv", "mat9.csv"],
      "3serie": ["port3.csv", "mat3.csv"]
    };

    const dadosCSV = { "9ano": [], "3serie": [] };

    const descritoresPort = {
      "H 01": "Localizar informações explícitas em um texto. Essencial para leitura básica; não dominar dificulta qualquer compreensão.",
      "H 02": "Inferir sentido de palavras. Importante para vocabulário; sem isso, a interpretação de textos fica comprometida.",
      "H 03": "Identificar tema central. Base para interpretação; ausência compromete análise global.",
      // ... continue até H15
    };

    const descritoresMat = {
      "HM 01": "Compreender números inteiros. Base para cálculos; sem isso, limita toda a matemática posterior.",
      "HM 02": "Resolver operações com frações. Essencial em proporções; não dominar prejudica álgebra e problemas do dia a dia.",
      "HM 03": "Resolver problemas de proporcionalidade. Crucial para matemática aplicada; falha gera dificuldade em física e química.",
      // ... continue até HM20
    };

    const turmaSelect = document.getElementById("turmaSelect");
    const alunoSelect = document.getElementById("alunoSelect");
    const ctx = document.getElementById("grafico").getContext("2d");
    let chart;

    // Carregar dados
    Object.keys(arquivos).forEach(turma => {
      arquivos[turma].forEach(arq => {
        Papa.parse(arq, {
          download: true,
          header: true,
          skipEmptyLines: true,
          delimiter: ";",
          complete: res => {
            res.data.forEach(linha => {
              dadosCSV[turma].push(linha);
            });
          }
        });
      });
    });

    turmaSelect.addEventListener("change", () => {
      alunoSelect.innerHTML = "<option value=''>-- Escolha um aluno --</option>";
      const turma = turmaSelect.value;
      if (turma && dadosCSV[turma]) {
        const alunos = [...new Set(dadosCSV[turma].map(l => l.Estudante))];
        alunos.forEach(aluno => {
          const opt = document.createElement("option");
          opt.value = aluno;
          opt.textContent = aluno;
          alunoSelect.appendChild(opt);
        });
      }
    });

    alunoSelect.addEventListener("change", () => {
      const turma = turmaSelect.value;
      const aluno = alunoSelect.value;
      if (!turma || !aluno) return;

      const dadosAluno = dadosCSV[turma].filter(l => l.Estudante === aluno);

      const labels = [];
      const valores = [];

      dadosAluno.forEach(linha => {
        Object.keys(linha).forEach(key => {
          if (key.startsWith("H ")) {
            labels.push(key);
            valores.push(parseInt(linha[key]) || 0);
          } else if (key.startsWith("HM")) {
            labels.push(key);
            valores.push(parseInt(linha[key]) || 0);
          }
        });
      });

      if (chart) chart.destroy();
      chart = new Chart(ctx, {
        type: "bar",
        data: {
          labels: labels,
          datasets: [{
            label: "Desempenho do Aluno",
            data: valores,
            backgroundColor: labels.map(l => l.startsWith("H ") ? "#2b6cb0aa" : "#38a169aa"),
            borderColor: labels.map(l => l.startsWith("H ") ? "#2b6cb0" : "#38a169"),
            borderWidth: 1
          }]
        },
        options: {
          scales: {
            y: {
              beginAtZero: true,
              max: 5, // ✅ limite ajustado
              ticks: { stepSize: 1 }
            }
          },
          plugins: {
            tooltip: {
              callbacks: {
                label: ctx => {
                  const key = ctx.label;
                  const desc = descritoresPort[key] || descritoresMat[key] || "Sem descrição disponível.";
                  return `${key}: ${ctx.formattedValue} acertos – ${desc}`;
                }
              }
            }
          }
        }
      });

      // descrições abaixo
      const descrDiv = document.getElementById("descricoes");
      descrDiv.innerHTML = "";
      labels.forEach((habilidade, i) => {
        const div = document.createElement("div");
        div.className = "habilidade";
        div.innerHTML = `<strong>${habilidade}</strong> ${descritoresPort[habilidade] || descritoresMat[habilidade] || "Sem descrição disponível."}`;
        descrDiv.appendChild(div);
      });
    });
  </script>
</body>
</html>
