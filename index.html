<!DOCTYPE html>
<html lang="pt-BR">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>1ª Avaliação Diagnóstica 2025</title>
  <script src="https://cdn.jsdelivr.net/npm/papaparse@5.4.1/papaparse.min.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
  <style>
    body { font-family: Arial, sans-serif; margin: 0; padding: 0; background: #f8f9fa; }
    header { background: #2c3e50; color: white; padding: 20px; text-align: center; }
    header h1 { margin: 0; font-size: 1.8rem; }
    header h2 { margin: 5px 0 0; font-weight: normal; font-size: 1.2rem; color: #ddd; }
    main { padding: 20px; max-width: 1200px; margin: auto; }
    select { padding: 6px; margin: 8px; font-size: 1rem; }
    #chart-container { position: relative; height: 500px; margin: 30px 0; background: white; padding: 20px; border-radius: 10px; box-shadow: 0 2px 6px rgba(0,0,0,0.1); }
    h3 { margin-top: 30px; }
    .habilidade { padding: 10px; }
    .habilidade:nth-child(odd) { background: #f1f1f1; }
    .habilidade:nth-child(even) { background: #e9ecef; }
  </style>
</head>
<body>
  <header>
    <h1>CCM Sebastião Paraná</h1>
    <h2>1ª Avaliação Diagnóstica 2025</h2>
  </header>
  <main>
    <label for="serie">Selecione o Ano/Série:</label>
    <select id="serie">
      <option value="">-- Escolha --</option>
      <option value="9ano">9º Ano Fundamental</option>
      <option value="3serie">3ª Série Ensino Médio</option>
    </select>

    <label for="aluno">Selecione o Aluno:</label>
    <select id="aluno"></select>

    <div id="chart-container">
      <canvas id="grafico"></canvas>
    </div>

    <div id="descricoes"></div>
  </main>

<script>
const arquivos = {
  "9ano": ["port9.csv", "mat9.csv"],
  "3serie": ["port3.csv", "mat3.csv"]
};

let dadosCSV = {};
let chart = null;

// descritores simplificados para pais
const descritoresPort = {
  "P01": "Identificar informações diretas em textos simples.",
  "P02": "Compreender a ideia principal de um parágrafo.",
  "P03": "Interpretar o sentido de palavras em contexto.",
  "P04": "Reconhecer a finalidade de textos de uso social.",
  "P05": "Localizar informações implícitas no texto.",
  "P06": "Interpretar gráficos e imagens em textos.",
  "P07": "Estabelecer relação entre partes do texto.",
  "P08": "Inferir a intenção do autor.",
  "P09": "Reconhecer recursos de linguagem figurada.",
  "P10": "Comparar informações em diferentes textos.",
  "P11": "Identificar o gênero textual.",
  "P12": "Reconhecer argumentos em textos de opinião.",
  "P13": "Identificar marcas linguísticas da narrativa.",
  "P14": "Reconhecer tempos verbais em textos.",
  "P15": "Interpretar textos poéticos."
};

const descritoresMat = {
  "M01": "Efetuar adições e subtrações em situações do dia a dia.",
  "M02": "Efetuar multiplicações e divisões simples.",
  "M03": "Resolver problemas com números inteiros.",
  "M04": "Compreender o conceito de fração.",
  "M05": "Resolver operações com frações.",
  "M06": "Resolver problemas com números decimais.",
  "M07": "Reconhecer porcentagem em contextos práticos.",
  "M08": "Resolver problemas com regra de três simples.",
  "M09": "Interpretar informações em gráficos e tabelas.",
  "M10": "Resolver problemas de medida de tempo.",
  "M11": "Calcular perímetro de figuras planas.",
  "M12": "Calcular área de figuras simples.",
  "M13": "Identificar propriedades de figuras geométricas.",
  "M14": "Resolver problemas com ângulos.",
  "M15": "Identificar sequências numéricas.",
  "M16": "Compreender noções de probabilidade simples.",
  "M17": "Resolver equações do 1º grau.",
  "M18": "Resolver equações do 2º grau.",
  "M19": "Interpretar funções em gráficos.",
  "M20": "Resolver problemas de geometria espacial."
};

// carregar CSV
function carregarCSV(chave, arquivosSerie) {
  dadosCSV[chave] = [];
  arquivosSerie.forEach(arq => {
    Papa.parse(arq, {
      download: true,
      header: true,
      skipEmptyLines: true,
      complete: res => {
        res.data.forEach(linha => {
          dadosCSV[chave].push(linha);
        });
      }
    });
  });
}

// popular alunos
document.getElementById("serie").addEventListener("change", function() {
  let serie = this.value;
  let alunoSel = document.getElementById("aluno");
  alunoSel.innerHTML = "";
  if (!serie) return;

  carregarCSV(serie, arquivos[serie]);

  setTimeout(() => {
    let alunos = [...new Set(dadosCSV[serie].map(d => d["Estudante"]))];
    alunos.forEach(al => {
      let opt = document.createElement("option");
      opt.value = al;
      opt.textContent = al;
      alunoSel.appendChild(opt);
    });
  }, 500);
});

// desenhar gráfico
document.getElementById("aluno").addEventListener("change", function() {
  let serie = document.getElementById("serie").value;
  let aluno = this.value;
  if (!aluno) return;

  let dadosAluno = dadosCSV[serie].filter(d => d["Estudante"] === aluno);
  let port = dadosAluno.find(d => d["Componente Curricular"]?.toLowerCase().includes("port"));
  let mat = dadosAluno.find(d => d["Componente Curricular"]?.toLowerCase().includes("mat"));

  let portData = port ? Object.keys(descritoresPort).map((k,i) => {
    let val = port[`H ${String(i+1).padStart(2,"0")}`];
    return val ? Number(val) : 0;
  }) : [];

  let matData = mat ? Object.keys(descritoresMat).map((k,i) => {
    let val = mat[`HM ${String(i+1).padStart(2,"0")}`];
    return val ? Number(val) : 0;
  }) : [];

  if (chart) chart.destroy();
  const ctx = document.getElementById("grafico").getContext("2d");

  chart = new Chart(ctx, {
    type: "bar",
    data: {
      labels: [...Object.keys(descritoresPort), ...Object.keys(descritoresMat)],
      datasets: [
        {
          label: "Português",
          data: [...portData, ...Array(matData.length).fill(null)],
          backgroundColor: "rgba(54,162,235,0.85)",
          barThickness: 35,
          borderRadius: 5
        },
        {
          label: "Matemática",
          data: [...Array(portData.length).fill(null), ...matData],
          backgroundColor: "rgba(255,99,132,0.85)",
          barThickness: 35,
          borderRadius: 5
        }
      ]
    },
    options: {
      responsive: true,
      maintainAspectRatio: false,
      plugins: {
        legend: {
          display: true,
          position: "top",
          labels: { font: { size: 14 }, color: "#333" }
        },
        tooltip: {
          callbacks: {
            label: ctx => {
              const key = ctx.label;
              const desc = descritoresPort[key] || descritoresMat[key];
              return `${key}: ${ctx.formattedValue}% – ${desc}`;
            }
          }
        }
      },
      scales: {
        x: {
          ticks: {
            autoSkip: false,
            maxRotation: 90,
            minRotation: 90,
            font: { size: 12 },
            color: "#333"
          }
        },
        y: {
          beginAtZero: true,
          max: 100,
          ticks: { stepSize: 10, font: { size: 14 }, color: "#333" }
        }
      }
    }
  });

  // descrições somente abaixo de 50%
  const descricoes = document.getElementById("descricoes");
  descricoes.innerHTML = "<h3>Habilidades em atenção</h3>";

  Object.keys(descritoresPort).forEach((k,i) => {
    if (portData[i] < 50) {
      descricoes.innerHTML += `<div class="habilidade"><b>${k}</b> – ${descritoresPort[k]}<br><i>Prejuízo:</i> O aluno terá dificuldade em compreender textos nesse aspecto.</div>`;
    }
  });

  Object.keys(descritoresMat).forEach((k,i) => {
    if (matData[i] < 50) {
      descricoes.innerHTML += `<div class="habilidade"><b>${k}</b> – ${descritoresMat[k]}<br><i>Prejuízo:</i> O aluno terá dificuldades em aplicar esse conceito em situações práticas.</div>`;
    }
  });
});
</script>
</body>
</html>
